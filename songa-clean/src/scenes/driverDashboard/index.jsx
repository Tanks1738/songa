import { Box, Typography, useTheme } from "@mui/material";
import { tokens } from "../../theme";
import Header from "../../components/Header";
import LineChart from "../../components/LineChart";
import StatBox from "../../components/StatBox";
import PieChart from "../../components/PieChart";
import AccountBalanceWalletIcon from "@mui/icons-material/AccountBalanceWallet";
import AttachMoneyIcon from "@mui/icons-material/AttachMoney";
import { useEffect, useState } from "react";
import axios from "axios";

const DriverDashboard = ({ driverId }) => {
  const theme = useTheme();
  const colors = tokens(theme.palette.mode);

  const [driverData, setDriverData] = useState([]);

  // ✅ Fetch only this driver’s data
  useEffect(() => {
    const fetchDriverData = async () => {
      try {
        const res = await axios.get(
          `http://localhost:3001/driver-dashboard/${driverId}`
        );
        setDriverData(res.data || []);
      } catch (err) {
        console.error("Failed to fetch driver data:", err);
      }
    };
    fetchDriverData();
  }, [driverId]);

  // ✅ Compute stats
  const totalGross = driverData.reduce(
    (sum, row) => sum + Number(row.gross || 0),
    0
  );
  const totalNet = driverData.reduce(
    (sum, row) => sum + Number(row.net || 0),
    0
  );

  // ✅ Weekly totals for line chart
  const weeklyTotals = driverData.reduce((acc, row) => {
    const week = row.week || row.Week;
    if (!week) return acc;
    if (!acc[week]) acc[week] = { gross: 0, net: 0 };
    acc[week].gross += Number(row.gross || 0);
    acc[week].net += Number(row.net || 0);
    return acc;
  }, {});

  const lineData = [
    {
      id: "Gross Earnings",
      color: "hsl(220, 70%, 50%)",
      data: Object.entries(weeklyTotals).map(([week, values]) => ({
        x: week,
        y: values.gross,
      })),
    },
    {
      id: "Net Earnings",
      color: "hsl(120, 70%, 50%)",
      data: Object.entries(weeklyTotals).map(([week, values]) => ({
        x: week,
        y: values.net,
      })),
    },
  ];

  // ✅ Pie chart: breakdown by week
  const pieData = Object.entries(weeklyTotals).map(([week, values]) => ({
    id: week,
    label: week,
    value: values.net,
  }));

  return (
    <Box m="20px">
      <Header
        title="Driver Dashboard"
        subtitle={`Welcome, ${driverId}`}
      />

      {/* Stat Boxes */}
      <Box display="grid" gridTemplateColumns="repeat(12, 1fr)" gap="20px">
        <Box
          gridColumn="span 6"
          backgroundColor={colors.primary[400]}
          display="flex"
          alignItems="center"
          justifyContent="center"
        >
          <StatBox
            title={`$${totalGross.toFixed(2)}`}
            subtitle="Gross Earnings"
            progress="0.75"
            increase="+14%"
            icon={
              <AttachMoneyIcon
                sx={{ color: colors.greenAccent[600], fontSize: "26px" }}
              />
            }
          />
        </Box>
        <Box
          gridColumn="span 6"
          backgroundColor={colors.primary[400]}
          display="flex"
          flexDirection="column"
          alignItems="center"
          justifyContent="center"
        >
          <StatBox
            title={`$${totalNet.toFixed(2)}`}
            subtitle="Net Earnings"
            progress="0.50"
            increase="+21%"
            icon={
              <AccountBalanceWalletIcon
                sx={{ color: colors.greenAccent[600], fontSize: "26px" }}
              />
            }
          />
          <Typography variant="h5" color={colors.greenAccent[400]} sx={{ mt: 1 }}>
            Total amount after deductions
          </Typography>
        </Box>
      </Box>

      {/* Line Chart */}
      <Box mt="40px" backgroundColor={colors.primary[400]} p="20px">
        <Typography variant="h5" fontWeight="600">
          Weekly Earnings
        </Typography>
        <Box height="250px">
          <LineChart isDashboard={true} data={lineData} />
        </Box>
      </Box>

      {/* Pie Chart */}
      <Box mt="40px" backgroundColor={colors.primary[400]} p="20px">
        <Typography variant="h5" fontWeight="600">
          Net Earnings Breakdown by Week
        </Typography>
        <Box height="250px">
          <PieChart isDashboard={true} data={pieData} />
        </Box>
      </Box>
    </Box>
  );
};

export default DriverDashboard;